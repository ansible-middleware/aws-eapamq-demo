---
- name: "EAP installation and configuration"
  hosts: eap
  become: yes
  collections:
    - middleware_automation.redhat_csp_download
    - middleware_automation.wildfly
    - middleware_automation.jcliff
  roles:
    - redhat_csp_download
    - jcliff
    - wildfly_install
    - wildfly_systemd
  tasks:
    - name: "Ensures webapp {{ app.name }} has been retrieved from {{ app.url }}"
      get_url:
        url: "{{ app.url }}"
        dest: "{{ wildfly_install_workdir }}/{{ app.name }}"
    - name: "Set info app destination"
      set_fact:
        info_app_dest: "{{ wildfly_install_workdir }}/{{ app.name }}"
    - name: Set jgroups stack to TCP
      include_role:
        name: wildfly_utils
        tasks_from: jboss_cli.yml
      vars:
        query: /subsystem=jgroups/channel=ee:write-attribute(name=stack,value=tcp)
        jboss_home: /opt/jboss-eap-7.4/
        jboss_cli_controller_host: localhost
        jboss_cli_controller_port: 9990
    # - name: Add messaging extension
    #   include_role:
    #     name: wildfly_utils
    #     tasks_from: jboss_cli.yml
    #   vars:
    #     query: /extension=org.wildfly.extension.messaging-activemq:add
    #     jboss_home: /opt/jboss-eap-7.4/
    #     jboss_cli_controller_host: localhost
    #     jboss_cli_controller_port: 9990
    # - name: Add messaging subsystem
    #   include_role:
    #     name: wildfly_utils
    #     tasks_from: jboss_cli.yml
    #   vars:
    #     query: /subsystem=messaging-activemq:add
    #     jboss_home: /opt/jboss-eap-7.4/
    #     jboss_cli_controller_host: localhost
    #     jboss_cli_controller_port: 9990
    # - name: Add messaging subsystem server
    #   include_role:
    #     name: wildfly_utils
    #     tasks_from: jboss_cli.yml
    #   vars:
    #     query: /subsystem=messaging-activemq/server=default:add
    #     jboss_home: /opt/jboss-eap-7.4/
    #     jboss_cli_controller_host: localhost
    #     jboss_cli_controller_port: 9990
    - name: "Fine tuning configuration"
      jcliff:
        wfly_home: "{{ wildfly_home }}"
        rule_file: "files/jcliff/{{ hostvars[inventory_hostname].tags.Site }}"
        timeout: 7000
        components:
          - system_properties:
            - name: JBOSS_ID
              value: "{{ inventory_hostname }}"
          - deployments:
            - name: "{{ info_app_dest | basename }}"
              path: "{{ info_app_dest }}"
          - modcluster:
              proxy:
                - name: default
                  proxies:
                    - proxy1
          - messaging_activemq:
              remote_connector:
                - name: netty-remote-broker
                  socket_binding: messaging-external-broker
              connection_factory:
                - name: activemq-ra-remote
                  connectors: netty-remote-broker
                  entries:
                    - java:/RemoteJmsXA
                    - java:jboss/RemoteJmsXA'
